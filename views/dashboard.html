<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resident Information</title>
  <link rel="stylesheet" href="style.css">
  <!-- SheetJS Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js "></script>
  <style>
    @media only screen and (max-width: 900px) {
     .table-actions {
      flex-wrap: wrap;
     }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Resident Information</h1>
  <div id="spinner" style="display: none;">
    <div></div>
    <p style="margin-top: 10px;">Saving changes...</p>
  </div>
  <div class="loading" id="loading">Loading data...</div>
  <div class="table-container"> 
    <div class="table-actions">
      <button id="editBtn" class="action-btn no-print">Edit</button>
      <button id="saveBtn" class="action-btn save-btn no-print" disabled>Save</button>
      <button onclick="printSection()" class="no-print print-button">Print</button>
      <button id="addRowBtn" class="action-btn no-print" style="background-color: #e67e22;">Add Row</button>
      <button id="addColumnFormulaBtn" class="action-btn no-print" style="background-color: #f1c40f;">Add Column</button>
      <!-- Inside .table-actions -->
      <input type="file" id="fileInput" accept=".xlsx,.xls" class="no-print" />
      <select id="sheetSelector" class="no-print" style="display:none;"></select>
      
      <button id="downloadBtn" class="action-btn no-print" style="background-color: #9b59b6;">Download</button>
      <button id="exportCsvBtn" class="action-btn no-print" style="background-color: #f39c12;">Export CSV</button>
      <button id="clearLocalStorageBtn" class="action-btn no-print" style="background-color: #e74c3c;">Clear</button>
    </div>
    <table id="residentTable" style="display: none;">
      <thead>
        <tr id="headerRow"></tr>
        <tr id="filterRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="footer-info no-print">
    <div id="entryInfo">Showing 0 to 0 of 0 entries</div>
    <div>
      Show
      <select id="pageSize" class="page-length-select">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="40">40</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
      entries
    </div>
    <ul class="pagination" id="pagination">
      <li><button id="prevBtn" onclick="goToPage(currentPage - 1)" disabled>Previous</button></li>
      <li><button id="nextBtn" onclick="goToPage(currentPage + 1)">Next</button></li>
    </ul>
  </div>
</div>

<!-- Add New Resident Modal -->
<div id="addRowModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Add New Resident</h2>
    <form id="addRowForm"></form>
    <div class="modal-footer">
      <button type="submit" form="addRowForm" class="action-btn save-btn">Save</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Confirm Deletion</h2>
    <p>Are you sure you want to delete this resident?</p>
    <div class="modal-footer">
      <button id="confirmDeleteBtn" class="action-btn delete-btn">Delete</button>
      <button id="cancelDeleteBtn" class="action-btn no-print">Cancel</button>
    </div>
  </div>
</div>
<!-- Add Formula Column Modal -->
<div id="addColumnModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Add Custom Formula Column</h2>
    <form id="addColumnForm">
      <div class="form-group">
        <label for="columnName">Column Name</label>
        <input type="text" id="columnName" name="columnName" placeholder="Enter column name" required />
      </div>
      <div class="form-group">
        <label for="columnFormula">Custom Formula</label>
        <input type="text" id="columnFormula" name="columnFormula" placeholder="e.g. =A+B" />
        <small>Available columns: <%= availableCols %></small>
      </div>
      <div class="form-group">
        <strong>Sample Output:</strong>
        <ul id="sampleOutput" style="list-style-type: none; padding-left: 0;"></ul>
      </div>
      <div class="modal-footer">
        <button type="submit" class="action-btn save-btn">Submit</button>
        <button type="button" id="cancelAddColBtn" class="action-btn no-print">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>


function ensureUniqueID(data, idField = 'ID') {
  const seenIDs = {};
  return data.map(item => {
    let id = item[idField];
    if (!id || seenIDs[id]) {
      let counter = 1;
      while (seenIDs[`${id}_${counter}`]) counter++;
      id = `${id || 'temp'}_${counter}`;
    }
    seenIDs[id] = true;
    item[idField] = id;
    return item;
  });
}


document.getElementById('addRowBtn').addEventListener('click', () => {
  openAddRowModal();
});

function openAddRowModal() {
  const currentSheet = document.getElementById('sheetSelector').value;
  const sampleRow = sheetDataMap[currentSheet][0] || {};
  const colNames = Object.keys(sampleRow).filter(k => k !== 'Row Number');
  const modal = document.getElementById('addRowModal');
  const form = document.getElementById('addRowForm');
  form.innerHTML = ''; // Clear previous content

  if (!colNames.length) {
    alert("No column structure found.");
    return;
  }

  colNames.forEach(col => {
    const group = document.createElement('div');
    group.className = 'form-group';
    const label = document.createElement('label');
    label.textContent = col;
    const input = document.createElement('input');
    input.type = 'text';
    input.name = col;
    input.placeholder = `Enter ${col}`;
    input.required = col === idColumn ? true : false;
    group.appendChild(label);
    group.appendChild(input);
    form.appendChild(group);
  });

  modal.style.display = 'block';
}

document.querySelector('.modal-close')?.addEventListener('click', () => {
  document.getElementById('addRowModal').style.display = 'none';
});

document.getElementById('addRowForm')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const currentSheet = document.getElementById('sheetSelector').value;
  const sampleRow = sheetDataMap[currentSheet][0] || {};
  
  // Only get real columns from current sheet
  const colNames = Object.keys(sampleRow).filter(k => k !== 'Row Number');
  
  const formData = {};
  const inputs = this.querySelectorAll('input');

  inputs.forEach(input => {
    const col = input.name;
    if (colNames.includes(col)) { // Only add if column exists in current sheet
      formData[col] = input.value.trim();
    }
  });

  const existingIds = new Set([
    ...residentData.map(r => r[idColumn]),
    ...filteredData.map(r => r[idColumn])
  ]);

  if (existingIds.has(formData[idColumn])) {
    alert("A row with this ID already exists!");
    return;
  }

  // Evaluate formula columns only for current sheet
  const sheetFormulas = window.sheetFormulas?.[currentSheet] || {};
  Object.keys(sheetFormulas).forEach(colName => {
    const formula = sheetFormulas[colName];
    try {
      formData[colName] = evaluateFormula(formula, formData);
    } catch (e) {
      formData[colName] = 'Error';
    }
  });

  residentData.push(formData);
  filteredData.push(formData);
  sheetDataMap[currentSheet].push(formData);

  document.getElementById('addRowModal').style.display = 'none';
  renderTable();
  saveToLocalStorage();
  alert('New row added successfully.');
});



window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('fileInput').addEventListener('change', handleFileSelect);
  document.getElementById('pageSize').addEventListener('change', e => {
    if (isEditing) disableEditing();
    pageSize = parseInt(e.target.value);
    currentPage = 1;
    renderTable();
  });

  // File Input
  if (localStorage.getItem('residentData')) {
    loadFromLocalStorage();
  } else {
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
  }

  // Download Button
  document.getElementById('downloadBtn').addEventListener('click', () => {
  const wb = XLSX.utils.book_new();

  for (const sheetName in sheetDataMap) {
    const ws = XLSX.utils.json_to_sheet(sheetDataMap[sheetName]);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  }

  XLSX.writeFile(wb, "ResidentData_Modified.xlsx");
});

  // Modal close handlers
  document.querySelector('.modal-close')?.addEventListener('click', () => {
    document.getElementById('addRowModal').style.display = 'none';
  });
  document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => {
    document.getElementById('deleteModal').style.display = 'none';
  });
  document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
  const currentSheet = document.getElementById('sheetSelector').value;

  if (selectedRowIndex >= 0) {
    residentData.splice(selectedRowIndex, 1);
    filteredData.splice(selectedRowIndex, 1);
    sheetDataMap[currentSheet] = sheetDataMap[currentSheet].filter((_, i) => i !== selectedRowIndex);
    renderTable();
    alert("Row deleted locally.");
  }
  saveToLocalStorage();

  document.getElementById('deleteModal').style.display = 'none';
  selectedRowForDelete = null;
  selectedRowIndex = -1;
});
});

function printSection() {
  window.print();
}



  

  document.getElementById('clearLocalStorageBtn').addEventListener('click', () => {
  if (confirm("Are you sure you want to delete all saved data from this browser?")) {
    localStorage.removeItem('residentData');
    localStorage.removeItem('sheetDataMap');
    localStorage.removeItem('currentSheet');
    alert("Saved data cleared from local storage.");
    location.reload(); // Reload the page to reset everything
  }
});

document.getElementById('addColumnFormulaBtn').addEventListener('click', () => {
  openAddColumnModal();
});






document.getElementById('addColumnForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const colName = document.getElementById('columnName').value.trim();
  const formula = document.getElementById('columnFormula').value.trim();
  const currentSheet = document.getElementById('sheetSelector').value;

  if (!colName) {
    alert("Please enter a column name.");
    return;
  }
  if (visibleColumns.includes(colName)) {
    alert("This column already exists!");
    return;
  }

  // Add column only to visible columns for current rendering
  visibleColumns.splice(visibleColumns.length - 1, 0, colName);
  optionalColumns.push(colName);

  // Store formula per sheet
  if (!window.sheetFormulas) window.sheetFormulas = {};
  window.sheetFormulas[currentSheet] = window.sheetFormulas[currentSheet] || {};
  window.sheetFormulas[currentSheet][colName] = formula;

  // Recalculate all rows only for current sheet
  updateFormulaColumns();

  initTable(); // Rebuild table UI
  saveToLocalStorage(); // Save updated state
  document.getElementById('addColumnModal').style.display = 'none';
  alert(`New column "${colName}" added to current sheet.`);
});



document.getElementById('cancelAddColBtn').addEventListener('click', () => {
  document.getElementById('addColumnModal').style.display = 'none';
});

document.querySelectorAll('#addColumnModal .modal-close').forEach(el => {
  el.addEventListener('click', () => {
    document.getElementById('addColumnModal').style.display = 'none';
  });
});


</script>

<script src="variables/variable.js"></script>

<script src="d2-function/d2-initTable.js"></script>

<script src="a4-function/a4-chc.js"></script>

<script src="r2-function/r2-cfc.js"></script>

<script src="b-function/b-rc.js"></script>

<script src="a3-function/a3-saci.js"></script>

<script src="l-function/l-st.js"></script>

<script src="y2-function/y2-usi.js"></script>

<script src="o3-function/o3-rt.js"></script>

<script src="j2-function/j2-gtp.js"></script>

<script src="y-function/y-sf.js"></script>

<script src="r-function/updated-r-ecr.js"></script>

<script src="a2-function/updated-a2-mc.js"></script>

<script src="m2-function/m2-ee.js"></script>

<script src="g-function/g-de.js"></script>

<script src="o2-function/o2-sed.js"></script>

<script src="h2-function/h2-sdm.js"></script>

<script src="n2-function/n2-hfs.js"></script>

<script src="a-function/a-lsd.js"></script>

<script src="m-function/m-stls.js"></script>

<script src="u-function/u-lfls.js"></script>

<script src="d-function/d-etc.js"></script>



<script src="n-function/n-oacm.js"></script>

<script src="o-function/o-rfs.js"></script>

<script src="h-function/h-ef.js"></script>

<script src="j-function/j-ufc.js"></script>

<script src="prevent/preventkey.js"></script>
<script src="prevent/prevent.js"></script>
</body>
</html>
